#NOTE: the heat vulnerability index uses the 2010 census tracts so we cannot merge them with the 2020 council districts. 


#Heat Vulnerability Index

#Open Data Philly
#HVI_score = Heat Vulnerability Index (2018)
#HSI_score = Heat sensitivity Index (2018)
#HEI_score = Heat exposure index (2018)

library(tidycensus)
library(tigris)
library(sf)
library(mapview)
library(dplyr)
library(readxl)
library(stringr)
library(ggplot2)
library(readr)
library(here)

setwd(here("Data"))

#Import CSV

data <- read_csv("Raw/heat_vulnerability_ct.csv") # data are by census tract

#load the block population
load("clean datasets/population_census_blocks.Rdata") 

#import 2010 to 2020 crosswalk
cross <- read_csv("Raw/crosswalk_2020_2010v2.csv")

# Remove the first two characters (i.e., '42' from the 'TRTID2010' column in the crosswalk)
cross <- cross %>%
  mutate(tract2010 = sub("^..", "", TRTID2010))

#Identify the tracts that exist in your HVI dataset
relevant_tracts <- data %>%
  mutate(tract2010 = sub("^42", "", geoid10)) %>%
  pull(tract2010)

#Filter the crosswalk to only include these relevant tracts
filtered_crosswalk <- cross %>%
  filter(tract2010 %in% relevant_tracts)  

#prepare data for merge
data <- data %>% 
  mutate(tract2010 = sub("^42", "", geoid10))

#merge crosswalk with HVI
merged_data <- filtered_crosswalk %>%
  left_join(data, by = "tract2010")  

#Group by 2020 block and weight based on percent
#weighted_data <- merged_data %>%
  #mutate(HVI_weighted = hvi_score * areal_perc)

#create tract id for merge
total_population_blocks <- population_census_blocks %>%
  mutate(GEOIDTRACT = str_sub(GEOID, 1, 11))

#Need to convert numeric to character for join
data2 <- data %>% mutate(GEOIDTRACT = as.character(geoid10))

#merge
total_join <- total_population_blocks %>%
  left_join (data2, by = "GEOIDTRACT")

#Use Shape Area? New WEIGHT
#Since shape area is at the block level --> I summed it for each Tract since
#The original tree is by Census tract
data3 <- total_join %>%
  group_by(GEOIDTRACT) %>%
  mutate(Tract_Area = sum(SHAPE_Area), 
         Tract_Area = case_when(is.nan(Tract_Area)~0, TRUE~ Tract_Area)) %>%
  ungroup()

#I took each Tract area, and created a weight for CD
data4 <- data3 %>%
  group_by(DISTRICT) %>%
  mutate(Weight = Tract_Area/sum(Tract_Area),
         Weight = case_when(is.nan(Weight)~0, TRUE~ Weight)) %>%
  ungroup()

#Heat vulnerability weights? Would probably not be based on population

#Not sure if this makes sense
data5 <- data4 %>%
  group_by(DISTRICT) %>%
  summarize(Heat_vul = sum(hvi_score*Weight, na.rm = TRUE), CD_pop = sum(value, na.rm = TRUE)) %>% #estimate is number uninsured per tract#
  ungroup()

# Calculate centroids for each district
data5_centroids <- data5 %>%
  st_centroid()


ggplot(data = data5, aes(fill = Heat_vul)) + 
  geom_sf() + 
  geom_text(data = data5_centroids, 
            aes(x = st_coordinates(geometry)[,1], 
                y = st_coordinates(geometry)[,2], 
                label = DISTRICT), 
            size = 4, color = "black") + 
  scale_fill_distiller(palette = "OrRd", direction = 1, 
                       breaks = c(-3, 2),  # Only label -3 and 2
                       labels = c("Very Low", "Very High")) + 
  labs(title = "Heat Vulnerability Index by Philadelphia 
       City Council District 2018",
       caption = "Data source: 2018 Open Data Philly",
       fill = "Heat Vulnerability 
         Index") + 
  theme_void()


