#Heat Vulnerability Index

#Open Data Philly
#HVI_score = Heat Vulnerability Index (2018)
#HSI_score = Heat sensitivity Index (2018)
#HEI_score = Heat exposure index (2018)

library(tidycensus)
library(tigris)
library(sf)
library(mapview)
library(dplyr)
library(readxl)
library(stringr)
library(ggplot2)
library(readr)

#Import CSV

data <- read_csv("C:/Documents/IDEA Fellow/heat_vulnerability_ct.csv")

#Population per Block
total_population_blocks <- get_decennial(
  geography = "block",
  variables = "P1_001N", # Total population
  state = "PA",
  county = "Philadelphia",
  year = 2020,
  geometry = TRUE #will add block geometry in this step
)
#check geometry
mapview(total_population_blocks)

#Council District #
Blocks2020_CouncilDistrict2024 <- read_excel(
  "C:/Documents/IDEA Fellow/Crosswalksmap/Blocks2020_CouncilDistrict2024.xlsx")
View(Blocks2020_CouncilDistrict2024)

joined_blocks <-merge(total_population_blocks, Blocks2020_CouncilDistrict2024, 
                      by.x = "GEOID", by.y = "GEOID20", all.x = TRUE, all.y = TRUE)

#Check geometry by district
mapview(joined_blocks, zcol = "DISTRICT")

#Adjust GeoID for merge
total_population_blocks <- joined_blocks %>%
  mutate(GEOIDTRACT = str_sub(GEOID, 1, 11))

#Need to convert numeric to character for join
data2 <- data %>% mutate(GEOID = as.character(geoid10))

#merge
total_join <- total_population_blocks %>%
  left_join (data2, by = c("GEOIDTRACT"="GEOID"))

#Use Shape Area? New WEIGHT
#Since shape area is at the block level --> I summed it for each Tract since
#The original tree is by Census tract
data2 <- total_join %>%
  group_by(GEOIDTRACT) %>%
  mutate(Tract_Area = sum(SHAPE_Area), 
         Tract_Area = case_when(is.nan(Tract_Area)~0, TRUE~ Tract_Area)) %>%
  ungroup()

#I took each Tract area, and created a weight for CD
data3 <- data2 %>%
  group_by(DISTRICT) %>%
  mutate(Weight = Tract_Area/sum(Tract_Area),
         Weight = case_when(is.nan(Weight)~0, TRUE~ Weight)) %>%
  ungroup()

#Heat vulnerability weights? Would probably not be based on population

#Not sure if this makes sense
data4 <- data3 %>%
  group_by(DISTRICT) %>%
  summarize(Heat_vul = sum(hvi_score*Weight, na.rm = TRUE), CD_pop = sum(value, na.rm = TRUE)) %>% #estimate is number uninsured per tract#
  ungroup()

# Calculate centroids for each district
data4_centroids <- data4 %>%
  st_centroid()


ggplot(data = data4, aes(fill = Heat_vul)) + 
  geom_sf() + 
  geom_text(data = data4_centroids, 
            aes(x = st_coordinates(geometry)[,1], 
                y = st_coordinates(geometry)[,2], 
                label = DISTRICT), 
            size = 4, color = "black") + 
  scale_fill_distiller(palette = "OrRd", direction = 1, 
                       breaks = c(-3, 2),  # Only label -3 and 2
                       labels = c("Very Low", "Very High")) + 
  labs(title = "Heat Vulnerability Index by Philadelphia 
       City Council District 2018",
       caption = "Data source: 2018 Open Data Philly",
       fill = "Heat Vulnerability 
         Index") + 
  theme_void()


