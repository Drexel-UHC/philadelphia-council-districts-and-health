#NOTE: the heat vulnerability index uses the 2010 census tracts so we cannot merge them with the 2020 council districts. 


#Heat Vulnerability Index

#Open Data Philly
#HVI_score = Heat Vulnerability Index (2018)
#HSI_score = Heat sensitivity Index (2018)
#HEI_score = Heat exposure index (2018)

library(tidycensus)
library(tigris)
library(sf)
library(mapview)
library(dplyr)
library(readxl)
library(stringr)
library(ggplot2)
library(readr)
library(here)

setwd(here("Data"))

#Import CSV

data <- read_csv("Raw/heat_vulnerability_ct.csv") # data are by census tract

#load the block population
load("clean datasets/population_census_blocks.Rdata") 

#import 2010 to 2020 crosswalk
cross <- read_csv("Raw/IPUMS_2010_2020_Crosswalk.csv")

data <- data %>%
  mutate(geoid10 = as.character(geoid10))

cross <- cross %>%
  mutate(tr2010ge = as.character(tr2010ge),
         blk2020ge = as.character(blk2020ge))

#Left join
merge_2010 <- data %>%
  left_join(cross, by = c("geoid10" = "tr2010ge"))

#Group by 2020 block and weight based on percent
#weighted_data <- merged_data %>%
  #mutate(HVI_weighted = hvi_score * areal_perc)

#create tract id for merge
#total_population_blocks <- population_census_blocks %>%
 # mutate(GEOIDTRACT = str_sub(GEOID, 1, 11))

#Need to convert numeric to character for join
#data2 <- data %>% mutate(GEOIDTRACT = as.character(geoid10))

#merge
total_join <- population_census_blocks %>%
  left_join (merge_2010, by = c("GEOID" = "blk2020ge"))

#Use Shape Area? New WEIGHT
#Since shape area is at the block level --> I summed it for each Tract since
#The original tree is by Census tract
#data3 <- total_join %>%
#  group_by(GEOIDTRACT) %>%
#  mutate(Tract_Area = sum(SHAPE_Area), 
#         Tract_Area = case_when(is.nan(Tract_Area)~0, TRUE~ Tract_Area)) %>%
 # ungroup()

#I took each Tract area, and created a weight for CD
#data4 <- data3 %>%
#  group_by(DISTRICT) %>%
#  mutate(Weight = Tract_Area/sum(Tract_Area),
#         Weight = case_when(is.nan(Weight)~0, TRUE~ Weight)) %>%
#  ungroup()


#P-area is the area of the original 2010 tract that is in the 2020 blocks?






















# Calculate centroids for each district
data5_centroids <- Districts_HVI %>%
  st_centroid()


ggplot(data = Districts_HVI, aes(fill = Heat_vul)) + 
  geom_sf() + 
  geom_text(data = data5_centroids, 
            aes(x = st_coordinates(geometry)[,1], 
                y = st_coordinates(geometry)[,2], 
                label = DISTRICT), 
            size = 4, color = "black") + 
  scale_fill_distiller(palette = "OrRd", direction = 1, 
                       breaks = c(-3, 2),  # Only label -3 and 2
                       labels = c("Very Low", "Very High")) + 
  labs(title = "Heat Vulnerability Index by Philadelphia 
       City Council District 2018",
       caption = "Data source: 2018 Open Data Philly",
       fill = "Heat Vulnerability 
         Index") + 
  theme_void()


